!function(){"use strict";const t={get raw(){return"undefined"!=typeof window&&window.DualChatbotConfig?window.DualChatbotConfig:{}},get restUrl(){return String(this.raw.restUrl||"")},get analyticsRestUrl(){return String(this.raw.analyticsRestUrl||"")},get logRestUrl(){return String(this.raw.logRestUrl||"")},get nonce(){return String(this.raw.nonce||"")},get debugEnabled(){return!!this.raw.debugEnabled},get maxMessageLength(){return Number(this.raw.maxMessageLength||2e3)}},e={tokens:5,last:Date.now()};async function n(n,a,o={}){if(t.debugEnabled&&t.logRestUrl&&function(){const t=Date.now(),n=(t-e.last)/1e3;return e.last=t,e.tokens=Math.min(5,e.tokens+2*n),e.tokens>=1&&(e.tokens-=1,!0)}())try{const e={level:String(n||"info"),message:String(a||""),url:String(location&&location.href||""),...o};await fetch(t.logRestUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":t.nonce},body:JSON.stringify(e)})}catch(t){}}const a={debug:(...e)=>{t.debugEnabled},info:(...e)=>{t.debugEnabled},warn:(...e)=>{t.debugEnabled},error:(...t)=>{try{n("error",t&&t[0]?String(t[0]):"error",{stack:t&&t[1]&&t[1].stack?String(t[1].stack):""})}catch(t){}}};"undefined"!=typeof window&&(window.DCB=window.DCB||{},window.DCB.logger=a,window.DCB.clientLog=n),function(){if(window.__DualChatbotInitialized)return;function t(t,e={}){return e.headers=e.headers||{},e.headers["X-WP-Nonce"]=DualChatbotConfig.nonce,fetch(t,e)}async function e(t,n={},a={tries:0,tried429:!1}){const o=t=>new Promise(e=>setTimeout(e,t));try{n.headers=n.headers||{},"X-WP-Nonce"in n.headers||(n.headers["X-WP-Nonce"]=DualChatbotConfig.nonce);const i=await fetch(t,n),s=await i.text();let r;try{r=JSON.parse(s)}catch{const t=new Error("REST_ERROR_GENERIC");throw t.status=i.status,t}if(!i.ok){const s=i.status,l=r&&(r.code||r.data&&r.data.status)||s,c=r&&r.message?r.message:"REST Fehler",d=new Error(`${s}:${c}`);if(d.status=s,d.code=l,s>=500&&s<600&&a.tries<3){const i=Math.min(1200,300*Math.pow(2,a.tries));return await o(i),e(t,n,{tries:a.tries+1,tried429:a.tried429})}if(429===s&&!a.tried429){let i=0;try{i=Number(r&&r.retry_after?r.retry_after:0)}catch(t){i=0}return(!Number.isFinite(i)||i<=0)&&(i=3),(async t=>{try{const e=Date.now()+Math.min(3e4,1e3*(t||0)),n=setInterval(()=>{const t=Math.max(0,e-Date.now()),a=Math.ceil(t/1e3);window.DCB&&"function"==typeof window.DCB.showToast&&window.DCB.showToast(`Zu viele Anfragen. Warte ${a}s…`),t<=0&&clearInterval(n)},1e3)}catch(t){}})(i),await o(Math.min(1e3*i,3e4)),e(t,n,{tries:a.tries,tried429:!0})}throw d}return r}catch(t){throw t}}window.__DualChatbotInitialized=!0,"undefined"!=typeof window&&(window.DCB=window.DCB||{},window.DCB.safeFetch=e);const n=!(!window.DualChatbotConfig||!DualChatbotConfig.debugEnabled),a=window.DualChatbotConfig&&DualChatbotConfig.logRestUrl?String(DualChatbotConfig.logRestUrl):"",o=window.DualChatbotConfig&&Number(DualChatbotConfig.maxMessageLength)?Number(DualChatbotConfig.maxMessageLength):2e3;function i(t){try{let e=null==t?"":String(t);return e=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),e=e.trim(),e?(e.length>o&&(e=e.slice(0,o)),e):""}catch(t){return""}}const s={tokens:5,last:Date.now()};async function r(e,o,i){try{if(!n||!a)return;if(!function(){const t=Date.now(),e=(t-s.last)/1e3;return s.last=t,s.tokens=Math.min(5,s.tokens+2*e),s.tokens>=1&&(s.tokens-=1,!0)}())return;const r=Object.assign({level:String(e||"info"),message:String(o||""),url:String(location&&location.href||"")},i||{});await t(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})}catch(t){}}if(n)try{window.addEventListener("error",function(t){try{r("error",t&&t.message?t.message:"window.onerror",{stack:t&&t.error&&t.error.stack?String(t.error.stack):"",line:t&&t.lineno?Number(t.lineno):0,col:t&&t.colno?Number(t.colno):0,url:String(location&&location.href||"")})}catch(t){}}),window.addEventListener("unhandledrejection",function(t){try{r("error",t&&t.reason?"string"==typeof t.reason?t.reason:t.reason&&t.reason.message?t.reason.message:"unhandledrejection":"unhandledrejection",{stack:t&&t.reason&&t.reason.stack?String(t.reason.stack):""})}catch(t){}})}catch(t){}const l=!(!window.DualChatbotConfig||!DualChatbotConfig.analyticsEnabled),c=window.DualChatbotConfig&&DualChatbotConfig.analyticsRestUrl?String(DualChatbotConfig.analyticsRestUrl).replace(/\/$/,""):"",d={clientId:function(){let t=function(){try{const t=document.cookie.match(new RegExp("(?:^|; )"+"dual_chatbot_cid".replace(/([.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):""}catch(t){return""}}();return t||(t=window.crypto&&crypto.randomUUID?crypto.randomUUID():Date.now().toString(16)+Math.random().toString(16).slice(2,10),function(t,e){try{const t=new Date;t.setTime(t.getTime()+31536e6),document.cookie=`dual_chatbot_cid=${encodeURIComponent(e)}; expires=${t.toUTCString()}; path=/; SameSite=Lax`}catch(t){}}(0,t)),t}(),startedFor:{},inactivityTimer:null,lastActivityAt:0};function u(t,e){try{if(!l||!c)return Promise.resolve();const n=Object.assign({type:t},e||{});return fetch(`${c}/analytics/track`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":DualChatbotConfig&&DualChatbotConfig.nonce?DualChatbotConfig.nonce:""},body:JSON.stringify(n)}).then(t=>t.ok?t.json().then(t=>t):t.text().then(e=>{try{JSON.parse(e)}catch(t){}throw new Error(`HTTP ${t.status}: ${e}`)})).catch(t=>{})}catch(t){return Promise.resolve()}}function h(t){t&&(d.startedFor[t]||(d.startedFor[t]=!0,u("session_start",{session_id:t,client_id:d.clientId,ts:String(Date.now())})))}function p(t){try{d.inactivityTimer&&(clearTimeout(d.inactivityTimer),d.inactivityTimer=null)}catch(t){}d.lastActivityAt=Date.now(),d.inactivityTimer=setTimeout(()=>{try{const e="function"==typeof t?t():null;e&&u("session_end",{session_id:e,client_id:d.clientId,ts:String(Date.now())})}catch(t){}},18e5)}function b(){try{const t=window.chatbotWrapper||document.getElementById("dual-chatbot-widget")||document.querySelector("#dual-chatbot-widget");if(t){t.hidden=!1,t.style.removeProperty("display"),t.style.removeProperty("visibility"),t.classList.remove("hidden","is-hidden","d-none"),"none"===getComputedStyle(t).display&&(t.style.display="block");const e=t.querySelector("#open-chatbot");e&&(e.hidden=!1,e.style.removeProperty("display"),e.style.removeProperty("visibility"),e.classList.remove("hidden","is-hidden","d-none"),"none"===getComputedStyle(e).display&&(e.style.display="inline-flex"),window.chatbotWrapper=t)}const e=document.querySelector(".dual-chatbot-icon");if(e){e.hidden=!1,e.style.removeProperty("display"),e.classList.remove("hidden","is-hidden","d-none");try{"none"===getComputedStyle(e).display&&(e.style.display="inline-flex")}catch(t){e.style.display="inline-flex"}}}catch(t){}}if(!window.DualChatbotConfig||!DualChatbotConfig.faqEnabled&&!DualChatbotConfig.advisorEnabled){try{document.addEventListener("DOMContentLoaded",b)}catch(t){}return}const y=!(!DualChatbotConfig.advisorEnabled||!DualChatbotConfig.isLoggedIn),m=!!DualChatbotConfig.faqEnabled,g=DualChatbotConfig.restUrl.replace(/\/$/,""),f=window.matchMedia("(max-width: 800px)"),C=()=>f.matches;let v=null,w=Object.create(null),S=Object.create(null),_=!1,E=null,L=0,T=null;function D(t,e="",n=[],a=null){const o=document.createElement(t);return e&&(o.className=e),n.forEach(t=>{"string"==typeof t?o.appendChild(document.createTextNode(t)):t instanceof Node&&o.appendChild(t)}),a&&(o.id=a),o}function A(){const t=D("div","dual-chatbot-message dual-chatbot-bot dual-chatbot-typing is-typing"),e=D("div","dual-typing");return e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Tippt …"),e.appendChild(D("span","dual-typing-dot")),e.appendChild(D("span","dual-typing-dot")),e.appendChild(D("span","dual-typing-dot")),t.appendChild(e),t}function x(t){try{t.querySelectorAll(".dual-chatbot-typing").forEach(t=>t.remove())}catch(t){}}function k(t,e){try{const n="members"===e||"advisor"===e?"members":"faq",a="dual_chatbot_greeted_"+n;if(t.querySelector(".dual-chatbot-message"))return;x(t);const o=A();t.appendChild(o),t.scrollTop=t.scrollHeight,setTimeout(()=>{x(t);const e="members"===n?window.DualChatbotConfig&&DualChatbotConfig.greetingMembers?String(DualChatbotConfig.greetingMembers):"":window.DualChatbotConfig&&DualChatbotConfig.greetingFaq?String(DualChatbotConfig.greetingFaq):"";if(e&&e.trim()){try{if("function"==typeof appendMessageToContainer)appendMessageToContainer(t,"bot",e);else{const n=D("div","dual-chatbot-message dual-chatbot-bot"),a=D("div","dual-chatbot-message-content");"function"==typeof M?M(a,e):a.textContent=e,n.appendChild(a),t.appendChild(n)}try{normalizeActionBars(t)}catch(t){}t.scrollTop=t.scrollHeight}catch(t){}try{sessionStorage.setItem(a,"1")}catch(t){}}},900)}catch(t){}}if(window.debugChatbotGreeting=function(){const t=document.querySelector(".dual-chatbot-chat-area"),e=document.querySelector(".dual-chatbot-main-chat");sessionStorage.removeItem("dual_chatbot_greeted_faq"),sessionStorage.removeItem("dual_chatbot_greeted_members"),t&&window.DualChatbotConfig?.faqEnabled&&k(t,"faq"),e&&window.DualChatbotConfig?.advisorEnabled&&k(e,"members")},"function"!=typeof M)var M=function(t,e){try{if(t&&t.classList&&t.classList.contains("dual-chatbot-message-content"))return t.innerHTML="",void(t.textContent=e||"");t.innerHTML="";const n=document.createElement("div");n.className="dual-chatbot-message-content",n.textContent=e||"",t.appendChild(n)}catch(n){try{t.textContent=e||""}catch(t){}}};function q(t,{className:e="dual-chatbot-header",controlsLeft:n=!1}={}){const a=D("div",e),o=D("span","dual-chatbot-header-title",[t]),i=D("div","dual-chatbot-controls"),s=D("button","dual-chatbot-close");return s.type="button",s.setAttribute("aria-label","Fenster schließen"),i.appendChild(s),n?(a.appendChild(i),a.appendChild(o)):(a.appendChild(o),a.appendChild(i)),{header:a,titleEl:o,closeBtn:s}}function I(t,e){try{const n=document.querySelector(".dual-chatbot-chat-area");if(!n)return;const a=D("div",`dual-chatbot-message dual-chatbot-${t}`);a.textContent=e,n.appendChild(a),n.scrollTop=n.scrollHeight}catch(t){}}function N(){const t=document.querySelector(".dual-chatbot-chat-area");t&&(t.scrollTop=t.scrollHeight)}async function P(n,a,o,s={}){const r=!(!s||!s.replaceBotEl);let l=i(n);if(!l)return;const c={message:l,context:"advisor"};v||(v=function(){try{if(window.crypto&&crypto.randomUUID)return crypto.randomUUID()}catch(t){}const t=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return`${t()}${t()}-${t()}-${t()}-${t()}-${t()}${t()}${t()}`}());let b=v;c.session_id=v;const y=s&&s.clientMsgId?s.clientMsgId:window.crypto&&crypto.randomUUID?crypto.randomUUID():Date.now().toString(16)+Math.random().toString(16).slice(2,10);c.client_msg_id=y,S[y]=Date.now(),h(v),p(()=>v),o&&(c.web_search=!0);const m=s&&s.replaceBotEl?s.replaceBotEl:null,f=s&&s.replaceBotId?s.replaceBotId:null;let C,_;(f||m)&&(c.no_user_insert=!0,c.target_bot_id=f||0),s&&s.noUserInsert&&(c.no_user_insert=!0);let E=null,L=null,T=!1;if(m)C=m,C.classList.add("is-typing"),_=C.querySelector(".dual-chatbot-message-content"),_||(_=D("div","dual-chatbot-message-content"),C.innerHTML="",C.appendChild(_)),_.innerHTML="",L=D("div","dual-typing"),L.setAttribute("role","status"),L.setAttribute("aria-live","polite"),L.setAttribute("aria-label","Tippt …"),L.appendChild(D("span","dual-typing-dot")),L.appendChild(D("span","dual-typing-dot")),L.appendChild(D("span","dual-typing-dot")),C.appendChild(L);else{if(r)return;C=D("div","dual-chatbot-message dual-chatbot-bot is-typing"),_=D("div","dual-chatbot-message-content"),C.appendChild(_);try{x(a),E=A(),a.appendChild(E),a.scrollTop=a.scrollHeight}catch(t){}}const k=()=>{a.scrollTop+a.clientHeight>=a.scrollHeight-40&&(a.scrollTop=a.scrollHeight)},q=()=>{try{L&&L.remove&&(L.remove(),L=null),m||T||(E&&E.remove&&(E.remove(),E=null),a.appendChild(C),T=!0)}catch(t){}k()};let I="",N="",P=null,O=!1;const B=Math.max(10,Math.floor(1e3/60));let $=!1;const U=async()=>{if($)return;$=!0,P&&(clearInterval(P),P=null),N&&N.length&&(I+=N,N=""),C.classList.remove("is-typing");const e=C.querySelector(".dual-chatbot-message-content")||C;M(e,I);const n=()=>{try{const t=C.querySelector(".dual-msg-actions");if(!t)return void normalizeActionBars(a||C.parentElement);t.querySelector(".dual-msg-btn")||(t.remove(),normalizeActionBars(a||C.parentElement))}catch(t){}};n(),requestAnimationFrame(()=>{n(),k()}),setTimeout(()=>{n(),k()},120),setTimeout(()=>{n(),k()},400),setTimeout(()=>{n(),k()},800),z=!0;try{f?await t(`${g}/edit_bot_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:f,session_id:b||v,content:I})}):await t(`${g}/append_history`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:b||v,sender:"bot",context:"advisor",message:I,reply_to_client_msg_id:y})})}catch(t){}try{if(m||f){const e=a||C.parentElement,n=async e=>{if(e&&e!==C&&e.classList&&e.classList.contains("dual-chatbot-bot")){const n=e.dataset&&e.dataset.id?Number(e.dataset.id):null;try{n&&await t(`${g}/delete_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n,session_id:b||v})})}catch(t){}try{e.remove()}catch(t){}}};let o=C.nextElementSibling;for(;o&&!o.classList.contains("dual-chatbot-user");){const t=o;o=o.nextElementSibling,await n(t)}let i=C.previousElementSibling;for(;i&&!i.classList.contains("dual-chatbot-user");){const t=i;i=i.previousElementSibling,await n(t)}try{normalizeActionBars(e)}catch(t){}}}catch(t){}},H=()=>{O&&0===N.length&&!P&&U()},j=()=>{if(!N.length)return clearInterval(P),P=null,void H();const t=N[0];N=N.slice(1),I+=t,(C.querySelector(".dual-chatbot-message-content")||C).textContent=I,k()};let z=!1;const R=t=>{var e;t&&((e=t)&&(N+=e,P||(P=setInterval(j,B))))};try{const e=new AbortController,n=await fetch(`${g}/stream_message`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":DualChatbotConfig.nonce},body:JSON.stringify(c),signal:e.signal});if(!n.ok||!n.body)throw new Error("Streaming nicht verfügbar");const o=n.body.getReader(),i=new TextDecoder;let s="",r=!1,l=setTimeout(()=>{try{r||e.abort()}catch(t){}},25e3);for(;;){const{value:t,done:e}=await o.read();if(e)break;let n;for(s+=i.decode(t,{stream:!0});(n=s.indexOf("\n"))>=0;){let t=s.slice(0,n);if(s=s.slice(n+1),t.endsWith("\r")&&(t=t.slice(0,-1)),t)try{const e=JSON.parse(t);if("meta"===e.type&&e.session_id){v=e.session_id,b=e.session_id;try{h(v)}catch(t){}}if("delta"===e.type&&e.content){const t=String(e.content);t&&t.length>0&&(r=!0,w[y]||(w[y]=Date.now()),q(),R(t),z||(buildMsgActions(C,"bot",null,""),z=!0))}"error"===e.type&&(C.textContent=e.message||"Fehler beim Streamen."),"done"===e.type&&(O=!0,U());continue}catch(e){if(t.startsWith("data:")){const e=t.slice(5).replace(/^\s+/,"");if("[DONE]"===e){O=!0,U();continue}try{const t=(((JSON.parse(e)||{}).choices||[])[0]||{}).delta||{};if("string"==typeof t.content&&t.content){const e=t.content;r=!0,w[y]||(w[y]=Date.now()),q(),R(e),z||(buildMsgActions(C,"bot",null,""),z=!0)}}catch(t){}}}}}if(clearTimeout(l),k(),H(),I){q(),P&&(clearInterval(P),P=null),N&&N.length&&(I+=N,N="");const e=C.querySelector(".dual-chatbot-message-content")||C;M(e,I),C.classList.remove("is-typing"),buildMsgActions(C,"bot",f||null,I);try{f?await t(`${g}/edit_bot_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:f,session_id:b||v,content:I})}):await t(`${g}/append_history`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:b||v,sender:"bot",context:"advisor",message:I,reply_to_client_msg_id:y})})}catch(t){}try{const t=S[y]||Date.now(),e=w[y]||Date.now();u("message_user",{session_id:v,client_id:d.clientId,msg_id:y,ts:String(t)}),u("message_bot",{session_id:v,client_id:d.clientId,reply_to:y,kb_hit:!1,latency_ms:Math.max(0,e-t),ts:String(e)}),p(()=>v)}catch(t){}try{normalizeActionBars(a||C.parentElement)}catch(t){}}}catch(n){try{const n=await e(`${g}/submit_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});v=n.session_id,b=n.session_id,P&&(clearInterval(P),P=null),N="",I=n.response||"",q();const o=C.querySelector(".dual-chatbot-message-content")||C;M(o,I),z||(buildMsgActions(C,"bot",f||null,I),z=!0);try{f&&await t(`${g}/edit_bot_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:f,session_id:b||v,content:I})})}catch(t){}try{const t=S[y]||Date.now(),e=Date.now();h(v),u("message_user",{session_id:v,client_id:d.clientId,msg_id:y,ts:String(t)}),u("message_bot",{session_id:v,client_id:d.clientId,reply_to:y,kb_hit:!1,latency_ms:Math.max(0,e-t),ts:String(e)}),p(()=>v)}catch(t){}try{normalizeActionBars(a||C.parentElement)}catch(t){}O=!0,H()}catch(t){q(),C.classList.remove("is-typing"),C.textContent=t.message||"Fehler"}}}function O(t=!1){window.__DualChatbotWidgetMounted||(y?function(t=!1){performance&&performance.now&&performance.now();let e=document.getElementById("dual-chatbot-container");if(e?(e.classList.add("dual-chatbot-container"),e.innerHTML="",e.hidden=!1,e.style.removeProperty("display"),e.style.removeProperty("visibility"),e.classList.remove("hidden","is-hidden","d-none")):e=D("div","dual-chatbot-container",[],"dual-chatbot-container"),document.body.appendChild(e),t)B();else{const t=D("button","dual-chatbot-icon");t.setAttribute("title","Chat"),window.DualChatbotConfig&&DualChatbotConfig.bubbleIconUrl&&(t.style.backgroundImage="url("+DualChatbotConfig.bubbleIconUrl+")",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center",t.style.backgroundSize="contain"),t.hidden=!1,t.style.removeProperty("display"),t.style.removeProperty("visibility"),t.classList.remove("hidden","is-hidden","d-none");try{"none"===getComputedStyle(t).display&&(t.style.display="inline-flex")}catch(e){t.style.display="inline-flex"}e.appendChild(t),t.addEventListener("click",()=>{_&&T?(T.style.display="flex",_=!1):B()})}}(t):m&&function(t=!1){const n=performance&&performance.now?performance.now():0;let a=document.getElementById("dual-chatbot-container");a?(a.classList.add("dual-chatbot-container"),a.innerHTML="",a.hidden=!1,a.style.removeProperty("display"),a.style.removeProperty("visibility"),a.classList.remove("hidden","is-hidden","d-none")):a=D("div","dual-chatbot-container",[],"dual-chatbot-container"),document.body.appendChild(a);let o=null;if(!t){o=D("button","dual-chatbot-icon"),o.setAttribute("title","Chat"),o.hidden=!1,o.style.removeProperty("display"),o.style.removeProperty("visibility"),o.classList.remove("hidden","is-hidden","d-none");try{"none"===getComputedStyle(o).display&&(o.style.display="inline-flex")}catch(t){o.style.display="inline-flex"}a.appendChild(o)}let s=t;const r=D("div","dual-chatbot-popup");r.style.display="none";const{header:l,closeBtn:c}=q(window.DualChatbotConfig&&DualChatbotConfig.faqHeaderTitle?DualChatbotConfig.faqHeaderTitle:"FAQ");try{c.setAttribute("aria-label",DualChatbotConfig&&DualChatbotConfig.labelClose?DualChatbotConfig.labelClose:"Close")}catch(t){}c.addEventListener("click",()=>{if(v)try{u("session_end",{session_id:v,client_id:d.clientId,ts:String(Date.now())})}catch(t){}s=!1,r.style.display="none",r.style.removeProperty("position"),r.style.removeProperty("top"),r.style.removeProperty("left"),r.style.removeProperty("right"),r.style.removeProperty("bottom"),r.style.removeProperty("width"),r.style.removeProperty("height"),r.style.removeProperty("border-radius"),r.style.removeProperty("z-index"),document.documentElement.classList.remove("dual-chatbot-modal-open"),document.body.classList.remove("dual-chatbot-modal-open"),o?o.style.display="":a.remove(),b(),window.widgetOpened=!1});const m=D("div","dual-chatbot-chat-area");try{m.setAttribute("role","log"),m.setAttribute("aria-live","polite"),m.setAttribute("aria-relevant","additions"),m.setAttribute("aria-label",DualChatbotConfig&&DualChatbotConfig.ariaChatLog?DualChatbotConfig.ariaChatLog:"Chat log")}catch(t){}const f=D("div","dual-chatbot-footer");f.style.position="sticky",f.style.bottom="0",f.style.background="inherit",f.style.zIndex="10";const w=D("textarea","dual-chatbot-input");w.setAttribute("rows",1),window.DualChatbotConfig&&DualChatbotConfig.inputPlaceholder&&(w.placeholder=DualChatbotConfig.inputPlaceholder),w.placeholder="Nachricht…";const _=D("button","dual-chatbot-send");try{_.setAttribute("aria-label",DualChatbotConfig&&DualChatbotConfig.labelSend?DualChatbotConfig.labelSend:"Send")}catch(t){}const E=D("span","dual-chatbot-icon-mask");_.appendChild(E),_.type="button";try{_.setAttribute("aria-label",DualChatbotConfig&&DualChatbotConfig.labelSend?DualChatbotConfig.labelSend:"Send")}catch(t){}const L=D("div","dual-chatbot-input-wrapper");L.appendChild(w),L.appendChild(_),f.appendChild(L),w.addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),_.dataset.sending||_.click())}),function(){const t=w,e=()=>{try{t.style.height="44px";const e=Math.min(t.scrollHeight,220);t.style.height=e+"px",t.style.overflowY=t.scrollHeight>220?"auto":"hidden"}catch(t){}};["input","change"].forEach(n=>t.addEventListener(n,e)),requestAnimationFrame(e)}();const T=()=>{_.classList.add("is-sending"),setTimeout(()=>{_.dataset.sending||_.classList.remove("is-sending")},120)};_.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||T()}),_.addEventListener("mousedown",T),r.appendChild(l),r.appendChild(m),r.appendChild(f),a.appendChild(r),t&&(r.style.display="flex",k(m,"faq")),o&&o.addEventListener("click",()=>{if(C())r.style.display="flex",r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.right="0",r.style.bottom="0",r.style.width="100vw",r.style.height="100vh",r.style.borderRadius="0",r.style.zIndex="999999",o.style.display="none",document.documentElement.classList.add("dual-chatbot-modal-open"),document.body.classList.add("dual-chatbot-modal-open"),k(m,"faq");else if(s=!s,r.style.display=s?"flex":"none",o.style.display=s?"none":"",s){k(m,"faq");try{w&&w.focus()}catch(t){}}}),_.addEventListener("click",async()=>{const t=w.value.trim();if(t){w.value="",w.dispatchEvent(new Event("input"));try{_.classList.add("is-sending"),_.dataset.sending="true",await async function(t){let n=i(t);if(!n)return;y||I("user",n);let a=document.querySelector(".dual-chatbot-chat-area")||document.querySelector(".dual-chatbot-main-chat")||null,o=null;try{a&&(x(a),o=A(),a.appendChild(o),a.scrollTop=a.scrollHeight)}catch(t){}const s={message:n,context:y?"advisor":"faq"};v&&(s.session_id=v);const r=window.crypto&&crypto.randomUUID?crypto.randomUUID():Date.now().toString(16)+Math.random().toString(16).slice(2,10);S[r]=Date.now(),p(()=>v);try{const t=await e(`${g}/submit_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});v=t.session_id,h(v);const n=S[r]||Date.now(),a=Date.now();u("message_user",{session_id:v,client_id:d.clientId,msg_id:r,ts:String(n)}),u("message_bot",{session_id:v,client_id:d.clientId,reply_to:r,kb_hit:!y,latency_ms:Math.max(0,a-n),ts:String(a)}),p(()=>v);try{o&&o.remove&&o.remove()}catch(t){}I("bot",t.response)}catch(t){try{t&&429===t.status?window.DCB&&"function"==typeof window.DCB.showToast&&window.DCB.showToast("Zu viele Anfragen. Bitte kurz warten."):t&&403===t.status&&window.DCB&&"function"==typeof window.DCB.showToast&&window.DCB.showToast("Keine Schreibrechte (nur SOLO/TEAMS).")}catch(t){}try{o&&o.remove&&o.remove()}catch(t){}I("bot",t.message)}}(t)}catch(t){}finally{delete _.dataset.sending,_.classList.remove("is-sending");try{w&&w.focus()}catch(t){}}}});try{if(n){const t=Math.round(performance.now()-n);u("perf_ui",{session_id:v||"ui",latency_ms:t,ts:String(Date.now())})}}catch(t){}}(t))}async function B(){const e=document.querySelector(".dual-chatbot-fullscreen");e&&e.remove();const n=D("div","dual-chatbot-fullscreen");T=n;const a=D("button","dual-chatbot-sidebar-handle");a.type="button";try{a.setAttribute("aria-label","Sidebar öffnen")}catch(t){}a.addEventListener("click",()=>N(!0)),n.appendChild(a);const o=D("div","dual-chatbot-sidebar");o.id="dcb-sidebar";const s=D("div","dual-chatbot-backdrop");if(DualChatbotConfig.profileUrl){const t=document.createElement("a");t.className="dual-chatbot-profile",t.href=DualChatbotConfig.profileUrl,t.rel="noopener noreferrer";const e=DualChatbotConfig.userName&&""!==DualChatbotConfig.userName.trim()?DualChatbotConfig.userName:DualChatbotConfig.isLoggedIn?"Profil":"Anmelden";if(DualChatbotConfig.userAvatar){const n=D("img");n.src=DualChatbotConfig.userAvatar,n.alt=e,t.appendChild(n)}const n=D("span","",[e]);t.appendChild(n),o.appendChild(t)}const r=D("div","dual-chatbot-sidebar-header"),l=D("span","dual-chatbot-sidebar-title",["Unterhaltungen"]),c=D("button","dual-chatbot-sidebar-toggle");c.type="button",c.setAttribute("aria-label","Sidebar schließen"),c.setAttribute("aria-expanded","true"),c.setAttribute("aria-controls","dcb-sidebar");const h=D("span","dual-chatbot-sidebar-toggle-icon");h.setAttribute("aria-hidden","true"),c.innerHTML="",c.appendChild(h);try{h.innerHTML=""}catch(t){}const p=D("span","dual-chatbot-icon-mask");p.setAttribute("aria-hidden","true"),h.appendChild(p);try{const t=r.querySelector(".dual-chatbot-sidebar-toggle");t&&t!==c&&t.remove()}catch(t){}r.appendChild(l),r.appendChild(c);const y=D("div","dual-chatbot-search-wrapper"),m=D("input","dual-chatbot-search");m.type="text",m.placeholder="Suchen…";const f=D("button","dual-chatbot-new-chat-btn",["+ Neuer Chat"]),w=D("ul","dual-chatbot-sidebar-list");if(y.appendChild(m),o.appendChild(r),C())try{n.classList.add("dual-chatbot-minimized"),c.setAttribute("aria-expanded","false"),c.setAttribute("aria-label","Sidebar öffnen"),_=!0}catch(t){}o.appendChild(y),o.appendChild(f),o.appendChild(w);const S=D("div","dual-chatbot-main"),A=D("div","dual-chatbot-main-chat");try{A.setAttribute("role","log"),A.setAttribute("aria-live","polite"),A.setAttribute("aria-relevant","additions"),A.setAttribute("aria-label",DualChatbotConfig&&DualChatbotConfig.ariaChatLog?DualChatbotConfig.ariaChatLog:"Chat log")}catch(t){}const x=D("div","dual-chatbot-main-footer"),{header:M,closeBtn:I}=q(window.DualChatbotConfig&&DualChatbotConfig.advisorHeaderTitle?DualChatbotConfig.advisorHeaderTitle:"Berater-Chat",{className:"dual-chatbot-main-header"});function N(t){n.classList.toggle("dual-chatbot-minimized",!t),c.setAttribute("aria-expanded",String(t));const e=t?"Sidebar schließen":"Sidebar öffnen";c.setAttribute("aria-label",e),c.setAttribute("title",e),_=!t}const O=D("button","dual-chatbot-microphone");O.type="button";try{O.setAttribute("aria-label",DualChatbotConfig&&DualChatbotConfig.labelMicrophone?DualChatbotConfig.labelMicrophone:"Microphone")}catch(t){}O.setAttribute("aria-pressed","false");const B=D("span","dual-chatbot-icon-mask");O.appendChild(B);const $=D("div","dual-chatbot-record-actions"),U=D("span","dual-chatbot-record-preview"),H=D("button","dual-chatbot-record-btn dual-chatbot-record-cancel");H.type="button",H.setAttribute("aria-label","Aufnahme abbrechen");const j=D("button","dual-chatbot-record-btn dual-chatbot-record-accept");j.type="button",j.setAttribute("aria-label","Transkript übernehmen"),$.appendChild(U),$.appendChild(H),$.appendChild(j);let z=null,R=!1;if(DualChatbotConfig.webSearchEnabled){z=D("button","dual-chatbot-search-toggle"),z.type="button",z.setAttribute("aria-label","Websuche"),z.setAttribute("title","Websuche");const t=D("span","dual-chatbot-icon-mask");t.setAttribute("aria-hidden","true"),z.appendChild(t),z.addEventListener("click",()=>{R=!R,z.classList.toggle("active",R)})}const W=D("div","dual-chatbot-input-wrapper"),J=D("textarea","dual-chatbot-input");J.setAttribute("rows",1),J.setAttribute("placeholder","Nachricht schreiben...");const F=D("button","dual-chatbot-send"),K=D("span","dual-chatbot-icon-mask");F.appendChild(K),F.type="button";const X=()=>{F.classList.add("is-sending"),setTimeout(()=>{F.dataset.sending||F.classList.remove("is-sending")},120)};let Y;F.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||X()}),F.addEventListener("mousedown",X),J.addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),F.click())}),function(){const t=J,e=()=>{try{t.style.height="44px";const e=Math.min(t.scrollHeight,220);t.style.height=e+"px",t.style.overflowY=t.scrollHeight>220?"auto":"hidden"}catch(t){}};["input","change"].forEach(n=>t.addEventListener(n,e)),requestAnimationFrame(e)}(),W.appendChild(J),W.appendChild(F),W.prepend(O),W.insertBefore($,O.nextSibling);let G=[],V=!1,Z=null,Q=null,tt="",et=!1;const nt=document.createElement("span");function at(){if(!V)return nt.textContent="",void(nt.style.display="none");const t=Math.floor((Date.now()-Z)/1e3),e=String(Math.floor(t/60)).padStart(2,"0"),n=String(t%60).padStart(2,"0");nt.textContent=`${e}:${n}`}function ot(){V=!1,O.classList.remove("recording"),clearInterval(Q),nt.textContent="",nt.style.display="none"}function it(t){$.style.display="inline-flex",$.classList.toggle("is-recording","recording"===t),$.classList.toggle("is-processing","processing"===t),$.classList.toggle("is-review","review"===t),nt.style.display="recording"===t?"inline-block":"none","recording"===t||"processing"===t?(j.style.display="none",H.style.display="",U.style.display="processing"===t?"":"none"):"review"===t&&(j.style.display="",H.style.display="",U.style.display="")}function st(){$.style.display="none",$.classList.remove("is-recording","is-processing","is-review"),U.textContent="",j.style.display="none",H.style.display="none",nt.style.display="none"}nt.className="dual-chatbot-record-timer",nt.style.marginLeft="10px",nt.style.fontSize="0.95em",nt.style.color="#e04a2f",nt.style.display="none",W.insertBefore(nt,O.nextSibling),O.addEventListener("click",async function(){if(V&&Y)return Y.stop(),void ot();if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});Y=new MediaRecorder(e),G=[],V=!0,et=!1,tt="",O.classList.add("recording"),nt.style.display="",it("recording"),Z=Date.now(),at(),Q=setInterval(at,250),Y.ondataavailable=t=>{G.push(t.data)},Y.onstop=async()=>{try{Y&&Y.stream&&Y.stream.getTracks().forEach(t=>t.stop())}catch(t){}if(ot(),et)return G=[],st(),void(et=!1);const e=new Blob(G,{type:"audio/webm"});U.textContent="Transkribiere ...",it("processing"),J.disabled=!0;const n=new FormData;n.append("audio",e,"recording.webm"),n.append("lang","de");try{const e=await t(DualChatbotConfig.whisperApiUrl,{method:"POST",body:n}),a=await e.json().catch(()=>({}));if(e.ok&&a&&(a.transcript||a.text))tt=(a.transcript||a.text||"").trim(),U.textContent=tt.length>64?tt.slice(0,64)+"...":tt,it("review");else{tt="";const t=a&&(a.error||a.message)?a.error||a.message:"Transkription fehlgeschlagen.";alert(t),st()}}catch(t){tt="",alert("Fehler beim Transkribieren: "+t.message),st()}finally{J.disabled=!1,J.focus()}},Y.start(),setTimeout(()=>{V&&"inactive"!==Y.state&&(Y.stop(),ot())},3e4)}catch(t){ot();try{Y&&Y.stream&&Y.stream.getTracks().forEach(t=>t.stop())}catch(t){}alert("Audiozugriff verweigert: "+t.message)}else alert("Audioaufnahme nicht unterstützt.")}),H.addEventListener("click",()=>{if(V&&Y&&"inactive"!==Y.state){et=!0;try{Y.stop()}catch(t){}try{Y&&Y.stream&&Y.stream.getTracks().forEach(t=>t.stop())}catch(t){}ot()}else tt="",st()}),j.addEventListener("click",()=>{tt&&(J.value=tt,J.dispatchEvent(new Event("input")),tt="",st(),J.focus())}),F.addEventListener("click",async()=>{const t=i(J.value.trim());if(t){J.value="",J.dispatchEvent(new Event("input"));try{F.classList.add("is-sending"),F.dataset.sending="true";const e=window.crypto&&crypto.randomUUID?crypto.randomUUID():Date.now().toString(16)+Math.random().toString(16).slice(2,10);ht(A,"user",t,null,{clientMsgId:e}),await P(t,A,R,{clientMsgId:e}),await lt(m.value.trim())}catch(t){}finally{delete F.dataset.sending,F.classList.remove("is-sending");try{J&&J.focus()}catch(t){}}}});const rt=void 0!==x&&x?x:D("div","dual-chatbot-main-footer");z&&rt.appendChild(z),rt.appendChild(W),S.appendChild(M),S.appendChild(A),S.appendChild(rt),n.appendChild(o),n.appendChild(S),n.appendChild(s),document.body.appendChild(n),window.__DualChatbotWidgetMounted=!0,document.documentElement.classList.add("dual-chatbot-modal-open"),document.body.classList.add("dual-chatbot-modal-open"),k(A,"members"),function(){const t=document.querySelector(".dual-chatbot-input");if(!t)return;const e=()=>{t.style.height="44px";const e=Math.min(t.scrollHeight,160);t.style.height=e+"px",t.style.overflowY=t.scrollHeight>160?"auto":"hidden"};["input","change"].forEach(n=>t.addEventListener(n,e)),requestAnimationFrame(e)}(),function(){try{const t=document.querySelector(".dual-chatbot-input");if(!t)return;const e=44,n=220;requestAnimationFrame(()=>{t.style.height=e+"px";const a=Math.min(t.scrollHeight,n);t.style.height=a+"px",t.style.overflowY=t.scrollHeight>n?"auto":"hidden"})}catch(t){}}();try{if(uiStart){const t=Math.round(performance.now()-uiStart);u("perf_ui",{session_id:v||"ui",latency_ms:t,ts:String(Date.now())})}}catch(t){}async function lt(e=""){try{const n=`${g}/search_sessions?query=${encodeURIComponent(e)}&context=advisor`;let a={sessions:[]};try{const e=await t(n,{method:"GET"}),o=await e.text();try{a=JSON.parse(o)}catch(t){}}catch(t){}w.innerHTML="",a.sessions&&a.sessions.length&&a.sessions.forEach(e=>{const n=e.title||e.session_id,a=D("li","dual-chatbot-session-item"),o=D("span","dual-chatbot-session-title",[n]);a.appendChild(o);const i=D("button","dual-chatbot-delete-btn");i.type="button",i.setAttribute("aria-label","Löschen"),i.setAttribute("title","Löschen");try{i.setAttribute("aria-label","Löschen"),i.setAttribute("title","Löschen")}catch(t){}const s=D("button","dual-chatbot-rename-btn");s.type="button",s.setAttribute("aria-label","Umbenennen"),s.setAttribute("title","Umbenennen"),s.innerHTML='\n  <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">\n    <path d="M3 17.25V21h3.75L17.81 9.94a1 1 0 0 0 0-1.41l-3.34-3.34a1 1 0 0 0-1.41 0L3 17.25zM14.06 5.19l3.34 3.34"\n          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n  </svg>\n';try{s.innerHTML=""}catch(t){}const r=D("span","dual-chatbot-icon-mask");r.setAttribute("aria-hidden","true"),s.appendChild(r),a.appendChild(s),a.appendChild(i),a.dataset.sessionId=e.session_id;const l=()=>{v=e.session_id,w.querySelectorAll("li").forEach(t=>{t.classList.remove("active"),t.removeAttribute("aria-current")}),a.classList.add("active"),a.setAttribute("aria-current","true"),async function(e){const n=++L;try{let a={history:[]};try{const n=await t(`${g}/get_history?session_id=${encodeURIComponent(e)}`,{method:"GET"}),o=await n.text();try{a=JSON.parse(o)}catch(t){}}catch(t){}if(n!==L)return;if(A.innerHTML="",a.history){const t=new Set,e=new Set;let n=null,o=null;const i=new Map;for(const t of a.history)if(t&&"bot"===t.sender&&t.reply_to_client_msg_id&&null!=t.id){const e=String(t.reply_to_client_msg_id),n=i.get(e);(!n||Number(t.id)>Number(n))&&i.set(e,Number(t.id))}a.history.forEach(a=>{const s=a.id||null,r=a.sender,l=a.client_msg_id||null,c=a.reply_to_client_msg_id||null,d=(a.message_content||"").trim();if("bot"===r){if(!d)return;if("0"===a.reply_to_client_msg_id||0===a.reply_to_client_msg_id)return;if(c&&null!=s){const t=i.get(String(c));if(null!=t&&Number(s)!==Number(t))return}}if(null!=s){const t=String(s);if(e.has(t))return;e.add(t)}if("user"===r&&l){if(t.has(l))return;t.add(l)}if("user"===r){if(null==l&&null!==n&&d===n)return;n=d}else{if(null==c&&null!==o&&d===o)return;o=d}ht(A,r,a.message_content,s,{clientMsgId:l,replyToClientMsgId:c})});try{!function(t){try{t.querySelectorAll(".dual-chatbot-message.dual-chatbot-bot").forEach(t=>{if(t.classList&&t.classList.contains("is-typing"))return;const e=(t.querySelector(".dual-chatbot-message-content")?.innerText||t.innerText||"").trim(),n=t.dataset&&t.dataset.replyToClientMsgId?t.dataset.replyToClientMsgId:null;if(!e||"0"===n||0===n){try{t.querySelectorAll(".dual-msg-actions").forEach(t=>t.remove())}catch(t){}try{t.remove()}catch(t){}}}),t.querySelectorAll(".dual-chatbot-message .dual-msg-actions").forEach(t=>{try{const e=t.parentElement;if(!e)return;(e.querySelector(".dual-chatbot-message-content")?.innerText||e.innerText||"").trim()||t.remove()}catch(t){}});const e=new Set;t.querySelectorAll(".dual-chatbot-message[data-id]").forEach(t=>{const n=t.dataset&&t.dataset.id?String(t.dataset.id):"";if(n)if(e.has(n))try{t.remove()}catch(t){}else e.add(n)})}catch(t){}}(A),ut(A)}catch(t){}}A.scrollTop=A.scrollHeight}catch(t){}}(e.session_id)};v&&v===e.session_id&&(a.classList.add("active"),a.setAttribute("aria-current","true")),o.addEventListener("click",t=>{t.stopPropagation(),l()}),a.addEventListener("click",l),o.addEventListener("dblclick",()=>{const n=o.textContent,i=D("input","dual-chatbot-rename-input");i.type="text",i.value=n,a.replaceChild(i,o),a.classList.add("is-renaming"),i.focus();const s=async()=>{const s=i.value.trim();s&&s!==n&&(await t(`${g}/rename_session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:e.session_id,title:s})}),o.textContent=s),a.replaceChild(o,i),a.classList.remove("is-renaming")};i.addEventListener("blur",s),i.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),s())})}),s.addEventListener("click",n=>{n.stopPropagation();const i=o.textContent,s=D("input","dual-chatbot-rename-input");s.type="text",s.value=i,a.replaceChild(s,o),a.classList.add("is-renaming"),s.focus();const r=async()=>{const n=s.value.trim();n&&n!==i&&(await t(`${g}/rename_session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:e.session_id,title:n})}),o.textContent=n),a.replaceChild(o,s),a.classList.remove("is-renaming")};s.addEventListener("blur",r),s.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),r())})}),i.addEventListener("click",async n=>{n.stopPropagation(),confirm("Gespräch löschen?")&&(await t(`${g}/delete_session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:e.session_id})}),v===e.session_id&&(v=null,A.innerHTML=""),await lt(m.value.trim()))}),w.appendChild(a)})}catch(t){}}function ct(t){const e=t.trim();return/^\{[\s\S]*\}$/.test(e)||/"\w+"\s*:/.test(e)?"json":/^<\/?[a-z!]/i.test(e)?"html":/function\s+|=>|const\s+|let\s+|console\./.test(e)?"javascript":/def\s+\w+\(|import\s+\w+|print\(/.test(e)?"python":/^\$|\becho\b|\bgrep\b|\bcat\b/.test(e)?"bash":/\$[a-z_]+\s*=|->|echo\s+|function\s*\(/i.test(e)?"php":/^\.|\#[^{]+\{|\bcolor:|display:/.test(e)?"css":"text"}function dt(e,n,a,o){try{const t="string"==typeof o&&o.length?o:e.querySelector(".dual-chatbot-message-content")?.innerText||e.innerText||"";if(!t||!t.trim().length){try{e.querySelectorAll(".dual-msg-actions").forEach(t=>t.remove())}catch(t){}return}}catch(t){}const i=null!=a&&void 0!==a?String(a):e&&e.dataset&&e.dataset.id?String(e.dataset.id):"";let s=null;try{i&&(s=e.querySelector(`.dual-msg-actions[data-for-id="${CSS&&CSS.escape?CSS.escape(i):i}"]`))}catch(t){}s||(s=e.querySelector(".dual-msg-actions"));const r=e.querySelectorAll(".dual-msg-actions");if(r.length>1){for(let t=1;t<r.length;t++)r[t].remove();s=r[0]}if(s&&s.dataset&&"1"===s.dataset.initialized){if(s!==e.lastElementChild&&e.appendChild(s),"user"===n){let n=!1;try{const t=e.closest(".dual-chatbot-main-chat, .dual-chatbot-chat-area, .dual-chatbot-messages, .dual-chat-history, .dual-chatbot, body");if(t){let a=[];try{a=Array.from(t.querySelectorAll(":scope > .dual-chatbot-message.dual-chatbot-user"))}catch(e){a=Array.from(t.querySelectorAll(".dual-chatbot-message.dual-chatbot-user")).filter(e=>e.parentElement===t)}n=!a.length||a[a.length-1]===e}}catch(t){n=!1}if(n){if(!s.querySelector(".msg-edit")){const n=D("button","dual-msg-btn msg-edit icon-edit");n.setAttribute("aria-label","Bearbeiten"),n.setAttribute("data-tip","Bearbeiten"),n.addEventListener("click",()=>{const n=e.querySelector(".dual-chatbot-bubble"),i=e.querySelector(".dual-chatbot-message-content"),s=i?i.innerText:o||"",r=D("div","dual-chatbot-input-wrapper dual-inline-edit"),l=D("textarea","dual-chatbot-input");l.setAttribute("rows",1),l.value=s;try{e.classList.add("is-editing")}catch(t){}const c=D("button","msg-edit-cancel");c.type="button",c.setAttribute("aria-label","Abbrechen"),c.setAttribute("data-tip","Abbrechen"),c.setAttribute("title","Abbrechen");const d=D("button","dual-chatbot-send");d.type="button";const u=D("span","dual-chatbot-icon-mask");d.appendChild(u),r.appendChild(l),r.appendChild(c),r.appendChild(d),n?n.replaceWith(r):i&&i.replaceWith(r);const h=()=>{try{l.style.height="44px";const t=Math.min(l.scrollHeight,220);l.style.height=t+"px",l.style.overflowY=l.scrollHeight>220?"auto":"hidden"}catch(t){}};["input","change"].forEach(t=>l.addEventListener(t,h)),requestAnimationFrame(h),setTimeout(h,60),l.focus();const p=t=>{const n=D("div","dual-chatbot-bubble"),o=D("div","dual-chatbot-message-content");o.textContent=t,n.appendChild(o),r.replaceWith(n);try{e.classList.remove("is-editing")}catch(t){}dt(e,"user",a,t);try{const t=e.querySelector(".msg-edit");t&&t.focus()}catch(t){}},b=async()=>{const n=l.value.trim();if(!n||n===s)return void p(s);try{await t(`${g}/edit_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:a,session_id:v,content:n})})}catch(t){}p(n);let o=e.nextElementSibling;for(;o&&!o.classList.contains("dual-chatbot-bot")&&!o.classList.contains("dual-chatbot-user");)o=o.nextElementSibling;if(o&&o.classList.contains("dual-chatbot-bot")){const a=o.dataset&&o.dataset.id?Number(o.dataset.id):null;let i=o.nextElementSibling;for(;i&&!i.classList.contains("dual-chatbot-user");){if(i.classList.contains("dual-chatbot-bot")){try{const e=i.dataset&&i.dataset.id?Number(i.dataset.id):null;e&&await t(`${g}/delete_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,session_id:v})})}catch(t){}i.remove()}i=i.nextElementSibling}P(n,e.parentElement,!1,{replaceBotEl:o,replaceBotId:a})}else{const t=e&&e.dataset&&e.dataset.clientMsgId?e.dataset.clientMsgId:void 0;P(n,e.parentElement,!1,{noUserInsert:!0,clientMsgId:t})}},y=()=>p(s);d.addEventListener("click",b),c.addEventListener("click",y),r.addEventListener("keydown",t=>{"Escape"===t.key&&(t.preventDefault(),y())},!0),l.addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),b()),"Escape"===t.key&&(t.preventDefault(),y())})}),s.appendChild(n)}}else try{s.querySelectorAll(".msg-edit").forEach(t=>t.remove())}catch(t){}}return}s||(s=D("div","dual-msg-actions"));const l=D("button","dual-msg-btn msg-copy icon-copy");if(l.setAttribute("aria-label","Kopieren"),l.setAttribute("data-tip","Kopieren"),l.addEventListener("click",async()=>{const t=o||e.querySelector(".dual-chatbot-message-content")?.innerText||e.innerText;try{await navigator.clipboard.writeText(t),l.setAttribute("data-tip","Kopiert"),setTimeout(()=>l.setAttribute("data-tip","Kopieren"),1200)}catch(t){}}),s.innerHTML="",s.appendChild(l),"bot"===n){const n=D("button","dual-msg-btn msg-regen icon-regen");n.setAttribute("aria-label","Neu generieren"),n.setAttribute("data-tip","Neu generieren"),n.addEventListener("click",()=>{let t=e.previousElementSibling;for(;t&&!t.classList.contains("dual-chatbot-user");)t=t.previousElementSibling;const n=t?t.querySelector(".dual-chatbot-message-content")?.innerText||t.innerText:"";if(n){const t=a||(e.dataset&&e.dataset.id?Number(e.dataset.id):null);P(n,e.parentElement,!1,{replaceBotEl:e,replaceBotId:t})}}),s.appendChild(n);const o=D("button","dual-msg-btn msg-up icon-up");o.setAttribute("aria-label","Hilfreich"),o.setAttribute("data-tip","Hilfreich");const i=D("button","dual-msg-btn msg-down icon-down");i.setAttribute("aria-label","Nicht hilfreich"),i.setAttribute("data-tip","Nicht hilfreich");const r=async e=>{let n="";"down"===e&&(n=window.prompt("Was war nicht hilfreich? (optional)")||"");try{await t(`${g}/react_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:a||0,reaction:e,feedback:n})})}catch(t){}};o.addEventListener("click",()=>r("up")),i.addEventListener("click",()=>r("down")),s.appendChild(o),s.appendChild(i);const l=D("button","dual-msg-btn msg-del icon-del");l.setAttribute("aria-label","Löschen"),l.setAttribute("data-tip","Löschen"),l.addEventListener("click",async()=>{const n=e.parentElement;if(!confirm("Antwort löschen?"))return;const o=a||(e&&e.dataset&&e.dataset.id?Number(e.dataset.id):null);try{o&&await t(`${g}/delete_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:o,session_id:v})})}catch(t){}try{e.querySelectorAll(".dual-msg-actions").forEach(t=>t.remove()),e.remove()}catch(t){}try{ut(n)}catch(t){}}),s.appendChild(l)}else{const n=D("button","dual-msg-btn msg-edit icon-edit");n.setAttribute("aria-label","Bearbeiten"),n.setAttribute("data-tip","Bearbeiten");const i=D("button","dual-msg-btn msg-del icon-del");i.setAttribute("aria-label","Löschen"),i.setAttribute("data-tip","Löschen"),n.addEventListener("click",()=>{const n=e.querySelector(".dual-chatbot-bubble"),i=e.querySelector(".dual-chatbot-message-content"),s=i?i.innerText:o||"",r=D("div","dual-chatbot-input-wrapper dual-inline-edit"),l=D("textarea","dual-chatbot-input");l.setAttribute("rows",1),l.value=s;try{e.classList.add("is-editing")}catch(t){}const c=D("button","msg-edit-cancel");c.type="button",c.setAttribute("aria-label","Abbrechen"),c.setAttribute("data-tip","Abbrechen"),c.setAttribute("title","Abbrechen");const d=D("button","dual-chatbot-send");d.type="button";const u=D("span","dual-chatbot-icon-mask");d.appendChild(u),r.appendChild(l),r.appendChild(c),r.appendChild(d),n?n.replaceWith(r):i&&i.replaceWith(r);const h=()=>{try{l.style.height="44px";const t=Math.min(l.scrollHeight,220);l.style.height=t+"px",l.style.overflowY=l.scrollHeight>220?"auto":"hidden"}catch(t){}};["input","change"].forEach(t=>l.addEventListener(t,h)),requestAnimationFrame(h),setTimeout(h,60),l.focus();const p=t=>{const n=D("div","dual-chatbot-bubble"),o=D("div","dual-chatbot-message-content");o.textContent=t,n.appendChild(o),r.replaceWith(n);try{e.classList.remove("is-editing")}catch(t){}dt(e,"user",a,t);try{const t=e.querySelector(".msg-edit");t&&t.focus()}catch(t){}},b=async()=>{const n=l.value.trim();if(!n||n===s)return void p(s);try{await t(`${g}/edit_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:a,session_id:v,content:n})})}catch(t){}p(n);let o=e.nextElementSibling;for(;o&&!o.classList.contains("dual-chatbot-bot")&&!o.classList.contains("dual-chatbot-user");)o=o.nextElementSibling;if(o&&o.classList.contains("dual-chatbot-bot")){const a=o.dataset&&o.dataset.id?Number(o.dataset.id):null;let i=o.nextElementSibling;for(;i&&!i.classList.contains("dual-chatbot-user");){if(i.classList.contains("dual-chatbot-bot")){try{const e=i.dataset&&i.dataset.id?Number(i.dataset.id):null;e&&await t(`${g}/delete_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,session_id:v})})}catch(t){}i.remove()}i=i.nextElementSibling}P(n,e.parentElement,!1,{replaceBotEl:o,replaceBotId:a})}else{const t=e&&e.dataset&&e.dataset.clientMsgId?e.dataset.clientMsgId:void 0;P(n,e.parentElement,!1,{noUserInsert:!0,clientMsgId:t})}},y=()=>p(s);d.addEventListener("click",b),c.addEventListener("click",y),r.addEventListener("keydown",t=>{"Escape"===t.key&&(t.preventDefault(),y())},!0),l.addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),b()),"Escape"===t.key&&(t.preventDefault(),y())})}),i.addEventListener("click",async()=>{if(a){if(confirm("Nachricht löschen?"))try{await t(`${g}/delete_message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:a,session_id:v})}),e.remove()}catch(t){}}else e.remove()});let r=!1;try{const t=e.closest(".dual-chatbot-main-chat, .dual-chatbot-chat-area, .dual-chatbot-messages, .dual-chat-history, .dual-chatbot, body");if(t){const n=Array.from(t.querySelectorAll(".dual-chatbot-message.dual-chatbot-user")).filter(e=>e.parentElement===t);r=!n.length||n[n.length-1]===e}}catch(t){r=!1}if(r)s.appendChild(n);else try{s.querySelectorAll(".msg-edit").forEach(t=>t.remove())}catch(t){}s.appendChild(i)}s!==e.lastElementChild&&e.appendChild(s),s.dataset&&(s.dataset.initialized="1",i&&(s.dataset.forId=i))}function ut(t){try{t.querySelectorAll(".dual-chatbot-message").forEach(t=>{const e=t.querySelector(".dual-chatbot-message-content")?.innerText||t.innerText||"",n=!(!e||!e.trim().length),a=t.querySelectorAll(".dual-msg-actions");if(a.length>1)for(let t=0;t<a.length-1;t++)a[t].remove();if(!n){try{t.querySelectorAll(".dual-msg-actions").forEach(t=>t.remove())}catch(t){}return}let o=t.querySelector(".dual-msg-actions");if(o)return o!==t.lastElementChild&&t.appendChild(o),void(o.dataset&&(o.dataset.initialized="1"));if(t.classList.contains("dual-chatbot-bot"))try{dt(t,"bot",null,e)}catch(t){}else if(t.classList.contains("dual-chatbot-user"))try{dt(t,"user",null,e)}catch(t){}});try{const e=t.querySelector(".dual-chatbot-messages, .dual-chat-history")||t;let n=[];try{n=Array.from(e.querySelectorAll(":scope > .dual-chatbot-message.dual-chatbot-user"))}catch(t){n=Array.from(e.querySelectorAll(".dual-chatbot-message.dual-chatbot-user")).filter(t=>t.parentElement===e)}if(!n.length)return;const a=n[n.length-1];if(n.forEach(t=>{if(t!==a)try{t.querySelectorAll(".dual-msg-actions .msg-edit").forEach(t=>t.remove())}catch(t){}}),!a.querySelector(".dual-msg-actions .msg-edit")){const t=a.dataset&&a.dataset.id?Number(a.dataset.id):null,e=a.querySelector(".dual-chatbot-message-content")?.innerText||"";try{dt(a,"user",t,e)}catch(t){}}}catch(t){}}catch(t){}}function ht(t,e,n,a=null,o={}){try{if(a&&t.querySelector(`[data-id="${CSS.escape(String(a))}"]`))return;if(o&&o.clientMsgId){const e=String(o.clientMsgId);if(t.querySelector(`[data-client-msg-id="${CSS.escape(e)}"]`))return}if(o&&o.replyToClientMsgId){const e=String(o.replyToClientMsgId);if(t.querySelector(`[data-reply-to-client-msg-id="${CSS.escape(e)}"]`))return}}catch(t){}try{const t=(n||"").trim();if("bot"===e){if(!t)return;const e=o&&(o.replyToClientMsgId??null);if("0"===e||0===e)return}}catch(t){}const i=D("div",`dual-chatbot-message dual-chatbot-${e}`);a&&(i.dataset.id=String(a)),o&&o.clientMsgId&&(i.dataset.clientMsgId=String(o.clientMsgId)),o&&o.replyToClientMsgId&&(i.dataset.replyToClientMsgId=String(o.replyToClientMsgId));const s=D("div","dual-chatbot-message-content");if("bot"===e)!function(t,e){let n;t.classList&&t.classList.contains("dual-chatbot-message-content")?(t.innerHTML="",n=t):(t.innerHTML="",n=D("div","dual-chatbot-message-content"),t.appendChild(n));const a=/```(\w+)?\n([\s\S]*?)```/g;let o,i=0;for(;null!==(o=a.exec(e));){const t=e.slice(i,o.index);t&&n.appendChild(document.createTextNode(t));const s=(o[1]||ct(o[2])).toLowerCase(),r=D("pre","dual-codeblock"),l=D("code",`lang-${s}`);l.textContent=o[2];const c=D("button","dual-code-copy icon-copy");c.setAttribute("aria-label","Code kopieren"),c.setAttribute("data-tip","Kopieren"),c.type="button",c.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(o[2]),c.setAttribute("data-tip","Kopiert"),setTimeout(()=>c.setAttribute("data-tip","Kopieren"),1200)}catch(t){}});const d=D("span","dual-code-lang",[s]);r.appendChild(c),r.appendChild(d),r.appendChild(l),n.appendChild(r),i=a.lastIndex}const s=e.slice(i);s&&n.appendChild(document.createTextNode(s))}(s,n),i.appendChild(s);else{const t=D("div","dual-chatbot-bubble");s.textContent=n,t.appendChild(s),i.appendChild(t),dt(i,"user",a,n)}t.appendChild(i),"user"===e&&ut(t),t.scrollTop=t.scrollHeight}f.addEventListener("click",()=>{if(v)try{u("session_end",{session_id:v,client_id:d.clientId,ts:String(Date.now())})}catch(t){}v=null,A.innerHTML="",w.querySelectorAll("li").forEach(t=>t.classList.remove("active"));try{sessionStorage.removeItem("dual_chatbot_greeted_members")}catch(t){}k(A,"members")}),m.addEventListener("input",()=>{clearTimeout(E),E=setTimeout(()=>{lt(m.value.trim())},300)});try{const t=new MutationObserver(t=>{try{ut(A)}catch(t){}});n.__actionsObserver=t,t.observe(A,{childList:!0,subtree:!0}),requestAnimationFrame(()=>{try{ut(A)}catch(t){}}),setTimeout(()=>{try{ut(A)}catch(t){}},120)}catch(t){}c.addEventListener("click",()=>{N(!("true"===c.getAttribute("aria-expanded")))});try{const t=n.querySelector(".dual-chatbot-backdrop");t&&t.addEventListener("click",()=>{N(!1)})}catch(t){}try{n.addEventListener("keydown",t=>{!t||"Escape"!==t.key&&"Esc"!==t.key||N(!1)})}catch(t){}I.addEventListener("click",()=>{if(v)try{u("session_end",{session_id:v,client_id:d.clientId,ts:String(Date.now())})}catch(t){}try{E&&(clearTimeout(E),E=null)}catch(t){}try{n.__actionsObserver&&(n.__actionsObserver.disconnect(),delete n.__actionsObserver)}catch(t){}n.remove(),_=!1,document.documentElement.classList.remove("dual-chatbot-modal-open"),document.body.classList.remove("dual-chatbot-modal-open");const t=document.getElementById("dual-chatbot-container");t&&!t.querySelector(".dual-chatbot-icon")&&t.remove(),b(),window.widgetOpened=!1,window.__DualChatbotWidgetMounted=!1}),lt()}window.__DualChatbotBootBound||(window.__DualChatbotBootBound=!0,document.addEventListener("DOMContentLoaded",()=>{"visualViewport"in window?visualViewport.addEventListener("resize",N):window.addEventListener("resize",N);try{document.querySelectorAll(".dual-chatbot-chat-area").forEach(t=>pruneEmptyMessages(t))}catch(t){}const t=document.getElementById("open-chatbot");if(t){t.classList.add("dual-chatbot-open");const e=t.closest("#dual-chatbot-widget");e&&(e.hidden=!1,e.style.removeProperty("display"),e.classList.remove("hidden","is-hidden","d-none"),window.chatbotWrapper=e),t.hidden=!1,t.style.removeProperty("display"),t.classList.remove("hidden","is-hidden","d-none"),window.widgetOpened=!1,t.__dualClickBound||(t.__dualClickBound=!0,t.addEventListener("click",function(){if(!window.widgetOpened&&!document.querySelector(".dual-chatbot-fullscreen")&&!document.querySelector(".dual-chatbot-popup")){O(!0),window.widgetOpened=!0;const e=t.closest("#dual-chatbot-widget");e&&(e.style.display="none",window.chatbotWrapper=e)}})),setTimeout(()=>{try{document.querySelector(".dual-chatbot-icon")||document.querySelector(".dual-chatbot-fullscreen")||document.querySelector(".dual-chatbot-popup")||function(t){try{if(!t||!t.nodeType)return!1;const e=t.getBoundingClientRect();if(!e||e.width<=0||e.height<=0)return!1;const n=window.innerWidth||document.documentElement.clientWidth||0,a=window.innerHeight||document.documentElement.clientHeight||0;if(e.bottom<=0||e.right<=0||e.top>=a||e.left>=n)return!1;const o=getComputedStyle(t);if("none"===o.display||"hidden"===o.visibility)return!1;if(0===Number(o.opacity))return!1;let i=t;for(;i&&1===i.nodeType;){if("none"===getComputedStyle(i).pointerEvents)return!1;i=i.parentElement}if(t.hasAttribute&&(t.hasAttribute("disabled")||"true"===t.getAttribute("aria-disabled")))return!1;const s=e.left+e.width/2,r=e.top+e.height/2;if(s<0||r<0||s>=n||r>=a)return!1;const l=document.elementFromPoint(s,r);return!(!l||l!==t&&!t.contains(l))}catch(t){return!1}}(t)||O(!1)}catch(t){}},300)}else O()})),function(){if(window.__DualChatbotResizeBound)return;window.__DualChatbotResizeBound=!0;let t=C(),e=null;window.addEventListener("resize",()=>{e&&clearTimeout(e),e=setTimeout(()=>{const e=C();if(e!==t)if(t=e,e){try{const t=document.querySelector(".dual-chatbot-popup");t&&"none"!==getComputedStyle(t).display&&(t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.right="0",t.style.bottom="0",t.style.width="100vw",t.style.height="100vh",t.style.borderRadius="0",t.style.zIndex="999999",document.documentElement.classList.add("dual-chatbot-modal-open"),document.body.classList.add("dual-chatbot-modal-open"))}catch(t){}!document.querySelector(".dual-chatbot-fullscreen")&&y&&B()}else{try{const t=document.querySelector(".dual-chatbot-popup");t&&(t.style.removeProperty("position"),t.style.removeProperty("top"),t.style.removeProperty("left"),t.style.removeProperty("right"),t.style.removeProperty("bottom"),t.style.removeProperty("width"),t.style.removeProperty("height"),t.style.removeProperty("border-radius"),t.style.removeProperty("z-index"),document.documentElement.classList.remove("dual-chatbot-modal-open"),document.body.classList.remove("dual-chatbot-modal-open"));const e=document.querySelector(".dual-chatbot-fullscreen");if(e){const t=e.querySelector(".dual-chatbot-close");t?t.click():(e.remove(),document.documentElement.classList.remove("dual-chatbot-modal-open"),document.body.classList.remove("dual-chatbot-modal-open"),window.__DualChatbotWidgetMounted=!1)}}catch(t){}try{const t=!!document.getElementById("dual-chatbot-container"),e=!!document.querySelector(".dual-chatbot-icon");window.__DualChatbotWidgetMounted||t&&e||O(!1)}catch(t){}}},150)})}()}(),function(){if(t.debugEnabled)try{window.addEventListener("error",function(t){try{n("error",t&&t.message?t.message:"window.onerror",{stack:t&&t.error&&t.error.stack?String(t.error.stack):"",line:t&&t.lineno?Number(t.lineno):0,col:t&&t.colno?Number(t.colno):0})}catch(t){}}),window.addEventListener("unhandledrejection",function(t){try{n("error",t&&t.reason?"string"==typeof t.reason?t.reason:t.reason&&t.reason.message?t.reason.message:"unhandledrejection":"unhandledrejection",{stack:t&&t.reason&&t.reason.stack?String(t.reason.stack):""})}catch(t){}})}catch(t){}}()}();
//# sourceMappingURL=chatbot.min.js.map
